{% extends 'baseFront.html.twig' %}

{% block title %}{{ excursion.titre }} | TuniTrip{% endblock %}

{% block stylesheet %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />


<style>
/* HERO */
.home {
    position: relative;
    height: 420px;
    background: linear-gradient(rgba(28,34,40,0.5), rgba(28,34,40,0.5)), url('{{ asset('uploads/images/' ~ excursion.imagePrincipale) }}') center/cover no-repeat;
    background-size: cover;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: white;
}
.home::before {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(25, 32, 38, 0.8);
}
.home_content {
    position: relative;
    z-index: 2;
    margin-top: 60px; 
}
.home_title {
    font-size: 40px;
    color: #D7B65D;
    font-weight: 700;
    text-transform: uppercase;
}
.home_content p {
    font-size: 1.05rem;
    margin: 0;
    color: rgba(255,255,255,.8);
}

/* CAROUSEL */
#galleryCarousel img {
    height: 420px;
    object-fit: cover;
    border-radius: 8px;
}

/* INFO BOX */
.info-box, .info-box-modern {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border-left: 4px solid #d8b65d; /* accent dor√© */
}

.info-item i {
    color: #d8b65d; /* ic√¥nes importantes dor√©es */
    margin-right: 8px;
}

.info-item strong {
    color: #1c2228;
}


.info-item:last-child {
    border-bottom: none;
}


/* ACCORDIONS */
.accordion-button {
    font-weight: 600;
    font-size: 17px;
}

#map {
    height: 400px;
    width: 100%;
    border-radius: 10px;
    Z-index: 1; 
}

.btn-reserver, .btn-primary {
    background-color: #d8b65d; /* dor√© */
    color: #1c2228;
    border: none;
    font-weight: 600;
    border-radius: 12px;
    transition: all 0.3s;
}

.btn-reserver:hover, .btn-primary:hover {
    background-color: #c5a954; /* dor√© plus fonc√© au hover */
    color: #fff;
}

.link-modern {
    color: #1c2228;
    text-decoration: underline;
}

.link-modern:hover {
    color: #d8b65d;
}
.accordion-button {
    font-weight: 600;
    font-size: 17px;
    color: #1c2228;
}

.accordion-button:not(.collapsed) {
    background-color: #d8b65d;
    color: #1c2228;
}
.itinerary-step-trip {
    padding-left: 120px;
    position: relative;
}

.itinerary-step-trip:not(:last-child)::before {
    background: repeating-linear-gradient(
        to bottom,
        #d0d0d0 0px,
        #d0d0d0 8px,
        transparent 8px,
        transparent 12px
    );
}

.itinerary-icon-trip.number-icon {
    background: #d8b65d; /* dor√© pour les √©tapes */
    color: #1c2228;
}

.itinerary-icon-trip.start-icon, .itinerary-icon-trip.end-icon {
    background: #1c2228; /* sombre */
    color: #d8b65d; /* dor√© */
}
#map {
    border-radius: 10px;
    border: 2px solid #d8b65d;
}
.btn-recenter {
    background: #d8b65d;
    color: #1c2228;
    border: none;
}
.btn-recenter:hover {
    background: #c5a954;
    color: #fff;
}
body, p, .description, .stop-details {
    color: #1c2228;
    line-height: 1.6;
}

.toggle-description, .itinerary-link {
    color: #d8b65d;
}

.toggle-description:hover, .itinerary-link:hover {
    color: #1c2228;
}


.info-box-modern {
    background: #fff;
    border-radius: 16px;
    border: 1px solid #e5e5e5;
}

.icon-circle {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: #f3f6f9;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 20px;
    color: #0d6efd;
}

.link-modern {
    text-decoration: underline;
    color: #000;
    cursor: pointer;
}


.btn-reserver {
    font-size: 18px;
    font-weight: bold;
    border-radius: 12px;
    background: #0071eb;
    border: none;
}

.btn-reserver:hover {
    background: #0059b8;
}
/* Description en noir */
.description {
    color: #000; /* texte noir */
    display: -webkit-box;
    -webkit-line-clamp: 3; /* nombre de lignes visibles par d√©faut */
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.5;
}

/* Description √©tendue */
.description.expanded {
    -webkit-line-clamp: unset;
}

/* Lien Lire plus / Lire moins en noir et soulign√© */
.toggle-description {
    color: #000 !important;       /* couleur noire */
    text-decoration: underline !important; /* soulignement */
    cursor: pointer;
    display: inline-block;
    margin-top: 5px;
}

/* Container principal */
.itinerary-container-tripadvisor {
    position: relative;
    padding-left: 0;
    margin-top: 25px;
}

/* Chaque √©tape */
.itinerary-step-trip {
    position: relative;
    padding-left: 120px;
    padding-bottom: 40px;
    padding-top: 5px;
}

.itinerary-step-trip:not(:last-child)::before {
    content: '';
    position: absolute;
    left: 37px;
    top: 45px;
    bottom: -5px;
    width: 2px;
    background: repeating-linear-gradient(
        to bottom,
        #d0d0d0 0px,
        #d0d0d0 8px,
        transparent 8px,
        transparent 12px
    );
}

/* Ic√¥nes */
.itinerary-icon-trip {
    position: absolute;
    left: 0;
    top: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 13px;
    white-space: nowrap;
}

/* Badge D√©part */
.itinerary-icon-trip.start-icon {
    background-color: #ffc107;
    color: #000;
    padding: 6px 14px;
    border-radius: 16px;
    font-size: 13px;
}

/* Badge Destination */
.itinerary-icon-trip.end-icon {
    background-color: #ffc107;
    color: #000;
    padding: 6px 14px;
    border-radius: 16px;
    font-size: 13px;
}

/* Num√©ros */
.itinerary-icon-trip.number-icon {
    width: 36px;
    height: 36px;
    background: #000;
    color: #fff;
    border-radius: 50%;
    font-size: 16px;
    left: 20px;
}

/* Contenu */
.itinerary-content-trip h5 {
    margin: 0 0 8px 0;
    font-size: 18px;
    color: #000;
}

.itinerary-content-trip p {
    margin: 6px 0;
    font-size: 14px;
    line-height: 1.5;
}

.stop-details {
    color: #666;
    font-size: 14px;
    margin-bottom: 10px;
}

.admission-badge {
    display: inline-block;
    margin-left: 10px;
    padding: 2px 8px;
    background-color: #e8f5e9;
    color: #2e7d32;
    border-radius: 4px;
    font-size: 12px;
}

.itinerary-link {
    color: #000;
    text-decoration: underline;
    font-size: 14px;
    cursor: pointer;
    display: inline-block;
    margin-top: 8px;
}

.itinerary-link:hover {
    color: #333;
}

/* Contenu des d√©tails cach√© par d√©faut */
.details-content {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #eee;
}

.details-content p {
    line-height: 1.6;
}

.etape-photos img {
    margin-right: 10px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
}

/* Header de la carte */
.map-header {
    position: relative;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-recenter {
    position: absolute;
    top: 60px;
    right: 10px;
    z-index: 2;
    background: white;
    border: 2px solid #ccc;
    border-radius: 8px;
    padding: 8px 16px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.btn-recenter:hover {
    background: #f5f5f5;
}

.btn-recenter i {
    font-size: 16px;
}

/* Responsive */
@media (max-width: 992px) {
    .excursion-container {
        flex-direction: column !important;
    }
    
    .excursion-container > div {
        width: 100% !important;
    }
    
    #map {
        height: 60vh !important;
    }
}

.traveler-dropdown {
    min-width: 340px;
}

.counter button {
    width: 32px;
    height: 32px;
    border-radius: 50%;
}

.counter span {
    font-size: 1.1rem;
    min-width: 24px;
    display: inline-block;
    text-align: center;
}

.availability-section {
    background: #ffffff;
    border-radius: 12px;
}
.modern-date-input {
    background: #fff;
    border-radius: 12px;
    padding: 12px 16px;
    border: 1px solid #ddd;
    transition: all .3s;
}

.modern-date-input:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 10px rgba(13,110,253,0.2);
}

.traveler-icon-btn {
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 12px 16px;
    font-size: 16px;
    transition: .3s ease;
}

.traveler-icon-btn:hover {
    background: #eef1f4;
}

.traveler-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: #ff4d4d;
    color: white;
    padding: 2px 8px;
    border-radius: 50%;
    font-size: 13px;
    font-weight: bold;
}

.excursion-nav {
    display: flex;
    gap: 25px;
    padding: 15px 10px;
    border-bottom: 2px solid #e9ecef;
    position: sticky;
    top: 70px;
    background: #fff;
    z-index: 10;
}

.exc-nav-link {
    text-decoration: none;
    font-weight: 600;
    font-size: 17px;
    color: #000; /* üî• en noir */
    padding-bottom: 6px;
    cursor: pointer;
    transition: 0.3s;
    border-bottom: 3px solid transparent; /* permet soulignement propre */
}

.exc-nav-link:hover {
    color: #000;
}

.exc-nav-link.active {
    border-bottom: 3px solid #000; /* soulign√© en noir */
}

.reviews-section {
  max-width: 800px;
  margin: auto;
}

.review-card {
  background-color: #fff;
}

.review-header .review-author {
  font-size: 1.1rem;
}

.review-comment p {
  margin: 0;
}


</style>
{% endblock %}



{% block body %}

<!-- HERO SECTION -->
<div class="home">
    <div class="home_content">
        <div class="home_title">{{ excursion.titre }}</div>
        <p>Liste des excursions // Details</p>
    </div>
</div>


<div class="container my-5">

        <div class="row gx-4">

            <!-- LEFT COLUMN -->
            <div class="col-lg-8">

                {# ================= CAROUSEL ================= #}
                {% if excursion.images|length > 0 %}
                    <div id="galleryCarousel" class="carousel slide carousel-fade mb-4" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            {% for img in excursion.images %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <img src="{{ asset('uploads/images/' ~ img.imageUrl) }}" 
                                        class="d-block w-100 zoomable-image"
                                        data-index="{{ loop.index0 }}">
                                </div>
                            {% endfor %}
                        </div>

                        <button class="carousel-control-prev" type="button" data-bs-target="#galleryCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#galleryCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>
                    </div>

                {% endif %}

                {# ================= MODAL FULLSCREEN ================= #}
                <div class="modal fade" id="imageModal" tabindex="-1">
                    <div class="modal-dialog modal-fullscreen">
                        <div class="modal-content bg-dark">
                            <div class="modal-body d-flex justify-content-center align-items-center position-relative">

                                <!-- Bouton fermer -->
                                <button class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>

                                <!-- Image -->
                                <img id="modalImage" src="" class="img-fluid">

                                <!-- Fl√®che Gauche -->
                                <button id="prevImage" class="btn text-white position-absolute start-0 top-50 fs-1">
                                    ‚Äπ
                                </button>

                                <!-- Fl√®che Droite -->
                                <button id="nextImage" class="btn text-white position-absolute end-0 top-50 fs-1">
                                    ‚Ä∫
                                </button>

                            </div>
                        </div>
                    </div>
                </div>

                {# ================= NAVBAR INTERNE ================= #}
                <div class="excursion-nav mb-4">
                    <a href="javascript:void(0)" class="exc-nav-link active" data-target="#section-description">Description</a>
                    <a href="javascript:void(0)" class="exc-nav-link" data-target="#section-details">D√©tails</a>
                    <a href="javascript:void(0)" class="exc-nav-link" data-target="#section-itineraire">Itin√©raire</a>
                </div>

                {# ================= DESCRIPTION ================= #}
                <h3 class="section-title" id="section-description">Description</h3>

                <div class="description-container mb-3">
                    <p class="description" id="description-{{ excursion.id }}">
                        {{ excursion.description|nl2br|raw }}
                    </p>
                    <a href="javascript:void(0);" class="toggle-description" 
                    data-target="description-{{ excursion.id }}">...Plus</a>
                </div>

                {# ================= TABLEAU D√âTAILS ================= #}
                <table class="table table-bordered align-middle shadow-sm">
                    <tbody>
                        <tr>
                            <th class="bg-light w-25"><i class="bi bi-clock text-primary me-2 text-dark"></i>Dur√©e</th>
                            <td><strong>{{ excursion.duree }} jours</strong></td>
                        </tr>

                        <tr>
                            <th class="bg-light"><i class="bi bi-tag text-primary me-2 text-dark"></i>Cat√©gorie</th>
                            <td><strong>{{ excursion.categorie }}</strong></td>
                        </tr>

                        <tr>
                            <th class="bg-light"><i class="bi bi-geo-alt text-primary me-2 text-dark"></i>Localisation</th>
                            <td><strong>{{ excursion.localisation }}</strong></td>
                        </tr>

                        <tr>
                            <th class="bg-light"><i class="bi bi-people text-primary me-2 text-dark"></i>√Çges</th>
                            <td><strong>{{ excursion.ages }}</strong></td>
                        </tr>

                        <tr>
                            <th class="bg-light"><i class="bi bi-person-badge text-primary me-2 text-dark"></i>Max personnes</th>
                            <td><strong>{{ excursion.maxPers }}</strong></td>
                        </tr>

                        <tr>
                            <th class="bg-light"><i class="bi bi-book text-primary me-2 text-dark"></i>Guide</th>
                            <td><strong>{{ excursion.guide }}</strong></td>
                        </tr>
                    </tbody>
                </table>

            </div> <!-- FIN LEFT COLUMN -->

            <!-- RIGHT COLUMN : SIDEBAR -->
            <div class="col-lg-4 sticky-sidebar">

                {# ================= BLOC INFORMATIONS ================= #}
                <div class="info-box-modern mb-4 p-4 shadow-sm">
                    <h3 class="mb-4 fw-bold">Informations</h3>

                    <!-- Prix -->
                    <div class="d-flex align-items-start mb-4">
                        <div class="icon-circle me-3">
                            <i class="bi bi-cash-stack"></i>
                        </div>
                        <div>
                            <strong class="fs-5">√Ä partir de {{ excursion.prixParPersonne }} TND</strong><br>
                            <small class="text-muted">par adulte (prix variable selon le groupe)</small><br>
                            <a href="#" data-bs-toggle="modal" data-bs-target="#modalPrix" class="link-modern">
                                Garantie Prix le Plus Bas
                            </a>
                        </div>
                    </div>

                    <!-- R√©servez maintenant / Payez plus tard -->
                    <div class="d-flex align-items-start mb-4">
                        <div class="icon-circle me-3">
                            <i class="bi bi-arrow-repeat"></i>
                        </div>
                        <div>
                            <a href="#" data-bs-toggle="modal" data-bs-target="#modalReserver"
                            class="link-modern fw-semibold">R√©servez maintenant et payez plus tard</a>
                            <ul class="mt-1">
                                <li>Garantissez votre place tout en restant flexible.</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Annulation gratuite -->
                    {% if excursion.cancellation %}
                        <div class="d-flex align-items-start mb-4">
                            <div class="icon-circle me-3">
                                <i class="bi bi-shield-check"></i>
                            </div>
                            <div>
                                <a href="#" data-bs-toggle="modal" data-bs-target="#modalCancellation"
                                class="link-modern fw-semibold">Annulation gratuite</a>
                                <ul class="mt-1">
                                    <li>{{ excursion.cancellation }}</li>
                                </ul>
                            </div>
                        </div>
                    {% endif %}

                    <!-- BOUTON R√âSERVER -->
                    <div class="mt-4 text-center">
                        <a href="#section-reservation" class="btn btn-primary btn-reserver w-100 py-3">
                            R√©server maintenant
                        </a>
                    </div>
                </div>

                {# ================= BLOC QUESTIONS ================= #}
                <div class="info-box-modern mb-4 p-4 shadow-sm">
                    <h3 class="mb-3 fw-bold">Des questions ?</h3>

                    <div class="d-flex align-items-center mb-3">
                        <div class="icon-circle me-3">
                            <i class="bi bi-telephone-forward-fill"></i>
                        </div>
                        <strong class="fs-5">+216 93 313 278</strong>
                    </div>

                    <div class="d-flex align-items-center">
                        <div class="icon-circle me-3">
                            <i class="bi bi-chat-right-dots-fill"></i>
                        </div>
                        <a href="#" class="link-modern">Ouvrir le chat</a>
                    </div>
                </div>

            </div> <!-- FIN RIGHT COLUMN -->

        </div> <!-- FIN ROW -->
    
        <!-- ACCORDION D√âTAILS DE L‚ÄôEXCURSION -->
        <div class="col-lg-8 accordion mt-4" id="section-details-excursion">

            {% if excursion.inclusList|length > 0 %}
                <div class="accordion-item" id="section-details">
                    <h2 class="accordion-header" id="headingInclus">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInclus">
                            ‚úîÔ∏è Ce qui est inclus
                        </button>
                    </h2>
                    <div id="collapseInclus" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <ul>
                                {% for item in excursion.inclusList %}
                                    <li>{{ item.item }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            {% endif %}

            {% if excursion.nonInclusList|length > 0 %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingNonInclus">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNonInclus">
                            ‚ùå Ce qui n'est pas inclus
                        </button>
                    </h2>
                    <div id="collapseNonInclus" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <ul>
                                {% for item in excursion.nonInclusList %}
                                    <li>{{ item.item }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- D√©tails de l'excursion tri√©s par ordre -->
            {% if excursion.details|length > 0 %}
                {% set sortedDetails = excursion.details|sort((a, b) => a.ordre <=> b.ordre) %}

                {% set detailsAffiches = 0 %}

                {% for detail in sortedDetails %}
                    {% if detail.titre|trim is not empty and detail.description|trim is not empty %}
                        {% set detailsAffiches = detailsAffiches + 1 %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingDetail{{ detail.id }}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetail{{ detail.id }}">
                                    ‚Ä¢ {{ detail.titre }}
                                </button>
                            </h2>
                            <div id="collapseDetail{{ detail.id }}" class="accordion-collapse collapse">
                                <div class="accordion-body" style="line-height: 2;">
                                    {{ detail.description|nl2br|raw }}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}

                {% if detailsAffiches == 0 %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingDetailEmpty">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetailEmpty">
                                ‚Ä¢ D√©tails de l'excursion
                            </button>
                        </h2>
                        <div id="collapseDetailEmpty" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <p class="text-muted">Aucun d√©tail disponible.</p>
                            </div>
                        </div>
                    </div>
                {% endif %}

            {% else %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingDetailEmpty">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetailEmpty">
                            ‚Ä¢ D√©tails de l'excursion
                        </button>
                    </h2>
                    <div id="collapseDetailEmpty" class="accordion-collapse collapse show">
                        <div class="accordion-body">
                            <p class="text-muted">Aucun d√©tail disponible.</p>
                        </div>
                    </div>
                </div>
            {% endif %}

            {% if excursion.aPropos|length > 0 %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingApropos">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseApropos">
                            ‚Ä¢ √Ä Quoi s'attendre
                        </button>
                    </h2>
                    <div id="collapseApropos" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            {{ excursion.aPropos|nl2br|raw }}
                        </div>
                    </div>
                </div>
            {% endif %}

        </div>


        <!-- SECTION : Date & Voyageurs -->
        <div class="availability-section w-100 mt-5 p-4 border rounded shadow-sm">

            <div class="row align-items-center g-4">

                <!-- TITRE -->
                <div class="col-auto">
                    <h5 class="fw-bold m-0">S√©lectionner la date et les voyageurs</h5>
                </div>

                <!-- DATE PICKER -->
                <div class="col-md-3">
                    <input type="text" id="date-picker" class="form-control form-control-lg modern-date-input" placeholder="Choisir une date">
                </div>

                <!-- VOYAGEURS -->
                <div class="col-md-2">
                    <div class="dropdown" data-bs-auto-close="outside">

                        <!-- BOUTON ROND AVEC BADGE -->
                        <button class="traveler-icon-btn position-relative" type="button" data-bs-toggle="dropdown">
                            <span id="traveler-total-badge" class="traveler-badge">1</span>
                            <i class="bi bi-people-fill"></i>
                        </button>

                        <div class="dropdown-menu p-3 shadow traveler-dropdown">

                            <!-- ADULTES -->
                            <div class="traveler-row d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <strong>Adultes</strong><br>
                                    <small class="text-muted">18 - 99 ans</small>
                                </div>
                                <div class="counter">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="event.stopPropagation(); changeCount('adult', -1)">-</button>
                                    <span id="adult-count" class="mx-2">1</span>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="event.stopPropagation(); changeCount('adult', 1)">+</button>
                                </div>
                            </div>

                            <hr>

                            <!-- JEUNES -->
                            <div class="traveler-row d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <strong>Jeunes</strong><br>
                                    <small class="text-muted">13 - 17 ans</small>
                                </div>
                                <div class="counter">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="event.stopPropagation(); changeCount('young', -1)">-</button>
                                    <span id="young-count" class="mx-2">0</span>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="event.stopPropagation(); changeCount('young', 1)">+</button>
                                </div>
                            </div>

                            <hr>

                            <!-- ENFANTS -->
                            <div class="traveler-row d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <strong>Enfants</strong><br>
                                    <small class="text-muted">4 - 12 ans</small>
                                </div>
                                <div class="counter">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="event.stopPropagation(); changeCount('child', -1)">-</button>
                                    <span id="child-count" class="mx-2">0</span>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="event.stopPropagation(); changeCount('child', 1)">+</button>
                                </div>
                            </div>

                            <hr>

                            <!-- B√âB√âS -->
                            <div class="traveler-row d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <strong>B√©b√©s</strong><br>
                                    <small class="text-muted">0 - 3 ans (gratuit)</small>
                                </div>
                                <div class="counter">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="event.stopPropagation(); changeCount('baby', -1)">-</button>
                                    <span id="baby-count" class="mx-2">0</span>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="event.stopPropagation(); changeCount('baby', 1)">+</button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- BOUTON : OUVRIR MODAL -->
                <div class="col-md-auto">
                    <button class="btn btn-primary btn-lg px-4" data-bs-toggle="modal" data-bs-target="#reservationModal">
                        R√©server maintenant
                    </button>
                </div>

            </div>
        </div>

<!-- MODAL DE RESERVATION -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="reservationModalLabel">R√©server votre excursion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>

            <div class="modal-body">
                {{ form_start(reservationForm) }}

                <div class="row g-3">
                    <!-- Excursion -->
                    <div class="col-md-6">
                        {{ form_row(reservationForm.excursion) }}
                    </div>

                    <!-- Nom -->
                    <div class="col-md-6">
                        {{ form_row(reservationForm.nom) }}
                    </div>

                    <!-- Pr√©nom -->
                    <div class="col-md-6">
                        {{ form_row(reservationForm.prenom) }}
                    </div>

                    <!-- Adultes -->
                    <div class="col-md-3">
                        {{ form_row(reservationForm.adult) }}
                    </div>

                    <!-- Enfants -->
                    <div class="col-md-3">
                        {{ form_row(reservationForm.child) }}
                    </div>

                    <!-- Date & Heure -->
                    <div class="col-md-6">
                        {{ form_row(reservationForm.dateHeure) }}
                    </div>

                    <!-- Point de prise en charge -->
                    <div class="col-md-6">
                        {{ form_row(reservationForm.localisationPoint) }}
                    </div>
                </div>

                {{ form_widget(reservationForm.dateCreation) }}
                {{ form_widget(reservationForm.statut) }}

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="submit" class="btn btn-primary">Confirmer la r√©servation</button>
            </div>

            {{ form_end(reservationForm) }}

        </div>
    </div>
</div>


            <!-- DEUXI√àME ROW : Contenu full-width (Accordion + Itin√©raire + Map) -->
            <div class="row mt-4">
                <div class="col-12">

                    <!-- Itin√©raire + Map -->
                    <div class="excursion-container" 
                        style="display:flex; gap:20px; margin-top:30px; flex-wrap: wrap;">

                        <!-- LEFT : Itin√©raire styl√© TripAdvisor -->
                        <div style="flex: 1 1 40%; max-height:80vh; overflow-y:auto; padding-right:10px; min-width: 300px;">
                            <h2 class="section-title" id="section-itineraire">Itin√©raire</h2>

                            <div class="itinerary-container-tripadvisor">

                                <!-- Point de D√©part -->
                                <div class="itinerary-step-trip">
                                    <div class="itinerary-icon-trip start-icon">D√©part</div>
                                    <div class="itinerary-content-trip">
                                        <h5 class="fw-bold">On passera vous prendre</h5>
                                        <a href="#" class="itinerary-link">Voir les d√©tails du d√©part</a>
                                    </div>
                                </div>

                                {% set steps = excursion.itineraires|sort((a,b) => a.ordre <=> b.ordre) %}
                                {% for etape in steps %}
                                    <!-- √âtape de l'itin√©raire -->
                                    <div class="itinerary-step-trip etape-box"
                                        data-lat="{{ etape.latitude }}"
                                        data-lng="{{ etape.longitude }}">

                                        <div class="itinerary-icon-trip number-icon">{{ loop.index }}</div>

                                        <div class="itinerary-content-trip">
                                            <h5 class="fw-bold">{{ etape.titreEtape }}</h5>
                                            <p class="stop-details">
                                                {% if etape.dureeVisite %} Arr√™t : {{ etape.dureeVisite }} {% endif %}
                                                {% if etape.admission %} 
                                                    <span class="admission-badge">{{ etape.admission }}</span> 
                                                {% endif %}
                                            </p>

                                            <!-- Lien pour afficher les d√©tails -->
                                            <a href="javascript:void(0);" 
                                            class="itinerary-link toggle-details" 
                                            data-target="details-{{ loop.index }}">
                                                {% if etape.hasPhotos %} Voir les d√©tails et les photos {% else %} Voir les d√©tails {% endif %}
                                            </a>

                                            <!-- Contenu cach√© (description + photos) -->
                                            <div class="details-content" id="details-{{ loop.index }}" style="display: none;">
                                                <p class="text-muted mt-3">{{ etape.descriptionEtape }}</p>

                                                {% if etape.photos|length > 0 %}
                                                    <div class="etape-photos mt-3">
                                                        <div class="row g-2">
                                                            {% for photo in etape.photos %}
                                                                <div class="col-6">
                                                                    <img src="{{ asset('uploads/itineraire_photos/' ~ photo.imageUrl) }}" 
                                                                        class="img-fluid rounded" 
                                                                        alt="{{ photo.legende }}"
                                                                        style="width: 100%; height: 150px; object-fit: cover; cursor: pointer;"
                                                                        onclick="openPhotoModal('{{ asset('uploads/images/' ~ photo.imageUrl) }}', '{{ photo.legende }}')">
                                                                    {% if photo.legende %}
                                                                        <small class="text-muted d-block mt-1">{{ photo.legende }}</small>
                                                                    {% endif %}
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                {% endif %}

                                                <a href="javascript:void(0);" 
                                                class="itinerary-link toggle-details mt-2" 
                                                data-target="details-{{ loop.index }}">
                                                    Voir moins
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}

                                <!-- Point de Retour -->
                                <div class="itinerary-step-trip">
                                    <div class="itinerary-icon-trip end-icon">Destination</div>
                                    <div class="itinerary-content-trip">
                                        <h5 class="fw-bold">Retournerez au point de d√©part</h5>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- RIGHT : MAP -->
                        <div style="flex: 1 1 55%; min-width: 300px;">
                            <div class="map-header">
                                <button class="btn-recenter" onclick="recenterMap()">
                                    <i class="bi bi-crosshair"></i> Recentrer l'itin√©raire
                                </button>
                            </div>
                            <div id="map" style="height:75vh; width:100%; border-radius:10px;"></div>
                        </div>

                    </div> <!-- fin Itin√©raire + Map -->

                </div>
            </div> <!-- fin row full-width -->


        <!-- MODALS -->

        <!-- Modal Annulation -->
        <div class="modal fade" id="modalCancellation" tabindex="-1" aria-labelledby="modalCancellationLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalCancellationLabel">Conditions d'annulation</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Pour recevoir un remboursement complet, vous devez annuler plus de 24 heures avant l'heure de d√©but de l'exp√©rience.</p>
                        <ul style="padding-left: 20px; list-style: disc !important;">
                            <li>Si vous annulez moins de 24 heures avant l'heure de d√©but de l'exp√©rience, le montant que vous avez pay√© ne sera pas rembours√©.</li>
                            <li>Aucune modification effectu√©e moins de 24 heures avant l'heure de d√©but de l'exp√©rience ne sera accept√©e.</li>
                            <li>Les heures limites de r√©servation sont bas√©es sur le fuseau horaire de l'exp√©rience.</li>
                            <li>Cette exp√©rience n√©cessite des conditions m√©t√©o cl√©mentes. Si elle est annul√©e en raison du mauvais temps, nous vous proposerons une autre date ou le remboursement complet.</li>
                            <li>Pour avoir lieu, cette exp√©rience requiert un nombre minimum de voyageurs. Si elle est annul√©e car cette condition n'est pas remplie, nous vous proposerons une autre date/activit√© ou le remboursement complet.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal R√©servez maintenant et payez plus tard -->
        <div class="modal fade" id="modalReserver" tabindex="-1" aria-labelledby="modalReserverLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-xl">
                <div class="modal-content" style="border-radius: 16px; padding: 10px 20px;">
                    <div class="modal-header border-0">
                        <h3 class="modal-title fw-bold" style="color:#0b3d2e;" id="modalReserverLabel">R√©servez maintenant et payez plus tard</h3>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body pb-4">
                        <p class="mb-4" style="font-size:17px;">
                            Nous r√©servons votre place aujourd'hui et vous pouvez annuler jusqu'√† deux jours* avant 
                            le d√©but de votre exp√©rience sans effectuer de paiement. 
                            Garantissez votre place facilement, restez flexible et ne manquez rien.
                        </p>

                        <!-- HOW IT WORKS -->
                        <div class="row gy-4">
                            {% for i, step in 0..4 %}
                                {% if i > 0 %}
                                    <div class="col-12 d-flex">
                                        <div class="me-3 d-flex align-items-start justify-content-center"
                                            style="width:42px;height:42px;border:2px solid #0b3d2e;border-radius:50%;font-weight:bold;font-size:18px;display:flex;align-items:center;justify-content:center;">
                                            {{ i }}
                                        </div>
                                        <div>
                                            {% if i == 1 %}
                                                <h5 class="fw-bold mb-1">Trouvez votre exp√©rience</h5>
                                                <p class="mb-0">Choisissez l'exp√©rience que vous voulez en sachant que votre place est acquise, sans vous bloquer pour autant.</p>
                                            {% elseif i == 2 %}
                                                <h5 class="fw-bold mb-1">Faire une r√©servation</h5>
                                                <p class="mb-0">R√©servez maintenant et payez plus tard pour garantir votre place, c'est sans engagement.</p>
                                            {% elseif i == 3 %}
                                                <h5 class="fw-bold mb-1">Choisissez quand payer</h5>
                                                <p class="mb-0">Revenez payer quand vos projets sont fix√©s, ou laissez le paiement automatique fonctionner deux jours* avant votre exp√©rience.</p>
                                            {% elseif i == 4 %}
                                                <h5 class="fw-bold mb-1">Profitez de votre exp√©rience</h5>
                                                <p class="mb-0">Vous avez termin√© ! Amusez-vous bien.</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>

                        <p class="mt-3" style="font-size:14px; color:#555;">
                            * Jusqu'√† neuf jours en fonction de la r√©servation ou du produit.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Garantie Prix le Plus Bas -->
        <div class="modal fade" id="modalPrix" tabindex="-1" aria-labelledby="modalPrixLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content" style="border-radius: 12px;">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold" id="modalPrixLabel">Garantie Prix le Plus Bas</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>
                            Nous garantissons les prix les plus bas sur les plus de 400 000 exp√©riences disponibles
                            √† la r√©servation sur notre site. Si vous trouvez le m√™me produit moins cher en ligne jusqu'√†
                            48 heures apr√®s le d√©but de votre exp√©rience, nous vous remboursons la diff√©rence.
                        </p>

                        <h6 class="fw-bold mt-4">Rien de plus simple :</h6>

                        {% for i in 1..4 %}
                        <div class="d-flex mb-3">
                            <div class="rounded-circle border border-dark d-flex justify-content-center align-items-center"
                                style="width: 35px; height: 35px; font-weight: bold;">{{ i }}</div>
                            <div class="ms-3">
                                {% if i == 1 %}
                                    <strong>Rassemblez vos informations</strong><br>
                                    Pr√©sentez votre r√©f√©rence de r√©servation ou votre r√©f√©rence d'itin√©raire et un justificatif
                                    du prix inf√©rieur que vous avez trouv√©.
                                {% elseif i == 2 %}
                                    <strong>Envoyez-nous les informations</strong><br>
                                    Envoyez vos documents, votre nom et votre adresse postale par e-mail √†
                                    <a href="TuniTripSupport@gmail.com">TuniTripSupport@gmail.com</a>.
                                {% elseif i == 3 %}
                                    <strong>Nous passerons en revue</strong><br>
                                    Nous analyserons vos documents et nous vous recontacterons d√®s que possible.
                                {% elseif i == 4 %}
                                    <strong>Recevez votre remboursement</strong><br>
                                    Si les informations sont confirm√©es, nous vous rembourserons la diff√©rence de prix.
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}

                    </div>
                </div>
            </div>
        </div>
</div>

<!-- Leaflet Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
{% endblock %}



{% block script %}

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Toggle description -->
    <script>
        document.querySelectorAll('.toggle-description').forEach(link => {
            link.addEventListener('click', function () {
                const targetId = this.dataset.target;
                const desc = document.getElementById(targetId);

                if (desc.classList.contains('expanded')) {
                    desc.classList.remove('expanded');
                    this.textContent = '...Plus';
                } else {
                    desc.classList.add('expanded');
                    this.textContent = 'Moins d\'info';
                }
            });
        });
    </script>

    <!-- Map + markers -->
    <script>
        // Initialize map
        let map = L.map('map').setView([34.0, 9.0], 7);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        let markers = [];

        // Add markers for steps
        document.querySelectorAll('.etape-box').forEach((box, index) => {
            let lat = box.dataset.lat;
            let lng = box.dataset.lng;

            if (lat && lng) {
                let icon = L.divIcon({
                    className: 'custom-number-icon',
                    html: `
                        <div style="
                            background:#000; color:#fff; width:28px; height:28px;
                            border-radius:50%; display:flex; align-items:center;
                            justify-content:center; font-weight:bold; font-size:14px;
                        ">
                            ${index + 1}
                        </div>`,
                    iconSize: [28, 28],
                    iconAnchor: [14, 28]
                });

                let marker = L.marker([lat, lng], { icon: icon }).addTo(map);
                markers.push(marker);

                // Click scrolls map
                box.addEventListener("click", () => {
                    map.setView([lat, lng], 12);
                    marker.openPopup();
                });
            }
        });

        // Fit map to markers
        if (markers.length > 0) {
            let group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds());
        }
    </script>

    <!-- Recenter map -->
    <script>
        function recenterMap() {
            if (markers.length > 0) {
                let group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds(), { padding: [50, 50] });
            }
        }
    </script>

    <!-- Toggle √©tape d√©tails -->
    <script>
        document.querySelectorAll('.toggle-details').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();

                const targetId = this.dataset.target;
                const detailsDiv = document.getElementById(targetId);

                const parent = this.closest(".itinerary-content-trip");
                const showLink = parent.querySelector('.toggle-details[data-target="' + targetId + '"]:not(.mt-2)');
                const hideLink = parent.querySelector('.toggle-details.mt-2[data-target="' + targetId + '"]');

                // Si on clique sur "Voir les d√©tails"
                if (this === showLink) {
                    detailsDiv.style.display = "block";
                    showLink.style.display = "none";
                    hideLink.style.display = "inline-block";
                }

                // Si on clique sur "Voir moins"
                else if (this === hideLink) {
                    detailsDiv.style.display = "none";
                    hideLink.style.display = "none";
                    showLink.style.display = "inline-block";
                }
            });
        });


        // Hover effet √©tape
        document.querySelectorAll('.etape-box').forEach(box => {
            box.style.cursor = 'pointer';

            box.addEventListener('mouseenter', function () {
                this.style.backgroundColor = '#f8f9fa';
                this.style.borderRadius = '8px';
                this.style.marginLeft = '-10px';
                this.style.paddingLeft = '100px';
                this.style.transition = 'all 0.2s ease';
            });

            box.addEventListener('mouseleave', function () {
                this.style.backgroundColor = 'transparent';
                this.style.marginLeft = '0';
                this.style.paddingLeft = '90px';
            });
        });
    </script>

    <!-- Counters (version 1) -->
    <script>
        function changeCount(type, delta) {
            const countElem = document.getElementById(type + "-count");
            let value = parseInt(countElem.textContent);
            value = Math.max(0, value + delta);

            if (type === "adult") value = Math.max(1, value);

            countElem.textContent = value;
            updateTravelerText();
        }

        function updateTravelerText() {
            const adult = parseInt(document.getElementById("adult-count").textContent);
            const young = parseInt(document.getElementById("young-count").textContent);
            const child = parseInt(document.getElementById("child-count").textContent);
            const baby = parseInt(document.getElementById("baby-count").textContent);

            let parts = [];

            if (adult > 0) parts.push(adult + " Adulte" + (adult > 1 ? "s" : ""));
            if (young > 0) parts.push(young + " Jeune" + (young > 1 ? "s" : ""));
            if (child > 0) parts.push(child + " Enfant" + (child > 1 ? "s" : ""));
            if (baby > 0) parts.push(baby + " B√©b√©" + (baby > 1 ? "s" : ""));

            document.getElementById("travelers-text").textContent =
                parts.length ? parts.join(", ") : "1 Adulte";
        }
    </script>

    <!-- DatePicker -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            flatpickr("#date-picker", {
                minDate: "today",
                dateFormat: "Y-m-d",
                disableMobile: "true",
                altInput: true,
                altFormat: "d F Y",
                locale: { firstDayOfWeek: 1 }
            });
        });
    </script>

    <!-- Counters (version 2) -->
    <script>
        function changeCount(type, value) {
            const countElement = document.getElementById(type + "-count");
            let count = parseInt(countElement.textContent);

            if (count + value < 0) return;

            count += value;
            countElement.textContent = count;

            updateTotalTravelers();
        }

        function updateTotalTravelers() {
            let adult = parseInt(document.getElementById('adult-count').textContent);
            let young = parseInt(document.getElementById('young-count').textContent);
            let child = parseInt(document.getElementById('child-count').textContent);
            let baby = parseInt(document.getElementById('baby-count').textContent);

            let total = adult + young + child + baby;

            document.getElementById('traveler-total-badge').textContent = total;
        }
    </script>

    <!-- Navigation scroll -->
    <script>
        document.querySelectorAll(".exc-nav-link").forEach(link => {
            link.addEventListener("click", () => {
                const target = document.querySelector(link.getAttribute("data-target"));
                const offset = target.getBoundingClientRect().top + window.scrollY - 100;

                window.scrollTo({
                    top: offset,
                    behavior: "smooth"
                });

                document.querySelectorAll(".exc-nav-link").forEach(l => l.classList.remove("active"));
                link.classList.add("active");

                blockAutoActivation = true;
                setTimeout(() => blockAutoActivation = false, 800);
            });
        });

        let blockAutoActivation = false;

        window.addEventListener("scroll", () => {
            if (blockAutoActivation) return;

            const sections = {
                "#section-description": document.querySelector("#section-description"),
                "#section-details": document.querySelector("#section-details"),
                "#section-itineraire": document.querySelector("#section-itineraire")
            };

            let current = "";
            const scrollPos = window.scrollY + 150;

            for (const key in sections) {
                const secTop = sections[key].offsetTop;
                const secBottom = secTop + sections[key].offsetHeight;

                if (scrollPos >= secTop && scrollPos < secBottom) {
                    current = key;
                }
            }

            document.querySelectorAll(".exc-nav-link").forEach(link => {
                link.classList.remove("active");
                if (link.getAttribute("data-target") === current) {
                    link.classList.add("active");
                }
            });
        });
    </script>

    <!-- Modal zoom images -->
    <script>
        const images = [...document.querySelectorAll('.zoomable-image')];
        let currentIndex = 0;

        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        const modalImage = document.getElementById('modalImage');

        images.forEach(img => {
            img.addEventListener('click', () => {
                currentIndex = parseInt(img.dataset.index);
                showImage();
                modal.show();
            });
        });

        function showImage() {
            modalImage.src = images[currentIndex].src;
        }

        document.getElementById('prevImage').addEventListener('click', () => {
            currentIndex = (currentIndex - 1 + images.length) % images.length;
            showImage();
        });

        document.getElementById('nextImage').addEventListener('click', () => {
            currentIndex = (currentIndex + 1) % images.length;
            showImage();
        });

        document.addEventListener('keydown', (e) => {
            if (document.getElementById('imageModal').classList.contains('show')) {
                if (e.key === 'ArrowLeft') {
                    currentIndex = (currentIndex - 1 + images.length) % images.length;
                    showImage();
                }
                if (e.key === 'ArrowRight') {
                    currentIndex = (currentIndex + 1) % images.length;
                    showImage();
                }
            }
        });
    </script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const bars = document.querySelectorAll('.animate-bar');
    bars.forEach(bar => {
        const width = bar.dataset.width;
        bar.style.width = '0';
        setTimeout(() => {
            bar.style.transition = 'width 1s ease-in-out';
            bar.style.width = width;
        }, 100); // petit d√©lai pour d√©clencher l'animation
    });
});
</script>
{% endblock %}

