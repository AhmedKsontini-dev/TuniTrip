{% extends 'baseFront.html.twig' %}

{% block title %}{{ excursion.titre }} | TuniTrip {% endblock %}

{% block metaDescription %}
Découvrez l'excursion {{ excursion.titre }} à {{ excursion.localisation }} : programme détaillé, prix, durée, photos, avis clients et réservation facile avec TuniTrip.
{% endblock %}

{% block stylesheet %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="{{ asset('assetsFront/css/excursion_detail.css') }}">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="{{ asset('assetsFront/css/excursion_detail.css')}}" />

{% endblock %}



{% block body %}

<!-- HERO SECTION -->
<div class="home" style="--hero-bg: url('{{ asset('uploads/images/' ~ excursion.imagePrincipale) }}');">
    <div class="home_content">
        <h1 class="home_title">{{ excursion.titre }}</h1>
        <p>{{ 'excursion_detail.breadcrumb'|trans }}</p>
    </div>
</div>


<div class="container my-5">

        <div class="row gx-4">

            <!-- LEFT COLUMN -->
            <div class="col-lg-8">

                {# ================= CAROUSEL ================= #}
                {% if excursion.images|length > 0 %}
                    <div id="galleryCarousel" class="carousel slide carousel-fade mb-4" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            {% for img in excursion.images %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <img src="{{ asset('uploads/images/' ~ img.imageUrl) }}" alt="Excursion {{ excursion.titre }} à {{ excursion.localisation }}" 
                                        class="d-block w-100 zoomable-image"
                                        data-index="{{ loop.index0 }}" >
                                </div>
                            {% endfor %}
                        </div>

                        <button class="carousel-control-prev" type="button" data-bs-target="#galleryCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#galleryCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>
                    </div>

                {% endif %}

                {# ================= MODAL FULLSCREEN ================= #}
                <div class="modal fade" id="imageModal" tabindex="-1">
                    <div class="modal-dialog modal-fullscreen">
                        <div class="modal-content bg-dark">
                            <div class="modal-body d-flex justify-content-center align-items-center position-relative">

                                <!-- Bouton fermer -->
                                <button class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>

                                <!-- Image -->
                                <img id="modalImage" src="" class="img-fluid" alt="{{ excursion.titre }} tunitrip">

                                <!-- Flèche Gauche -->
                                <button id="prevImage" class="btn text-white position-absolute start-0 top-50 fs-1">
                                    ‹
                                </button>

                                <!-- Flèche Droite -->
                                <button id="nextImage" class="btn text-white position-absolute end-0 top-50 fs-1">
                                    ›
                                </button>

                            </div>
                        </div>
                    </div>
                </div>

                {# ================= NAVBAR INTERNE ================= #}
                <div class="excursion-nav mb-4">
                    <a href="javascript:void(0)" class="exc-nav-link active" data-target="#section-description">{{ 'excursion_detail.nav.description'|trans }}</a>
                    <a href="javascript:void(0)" class="exc-nav-link" data-target="#section-details">{{ 'excursion_detail.nav.details'|trans }}</a>
                    <a href="javascript:void(0)" class="exc-nav-link" data-target="#section-itineraire">{{ 'excursion_detail.nav.itinerary'|trans }}</a>
                </div>

                {# ================= DESCRIPTION ================= #}
                <h3 class="section-title" id="section-description">{{ 'excursion_detail.description.title'|trans }}</h3>

                <div class="description-container mb-3">
                    <div class="description" id="description-{{ excursion.id }}">
                        {{ excursion.description|nl2br|raw }}
                    </div>
                    
                </div>



                {# ================= TABLEAU DÉTAILS ================= #}
                <table class="table table-bordered align-middle shadow-sm">
                    <tbody>
                        <tr>
                            <th class="bg-light w-25"><i class="bi bi-clock text-primary me-2 text-dark"></i>{{ 'excursion_detail.table.duration'|trans }}</th>
                            <td><strong>{{ excursion.duree }} {{ 'excursions.duration.days'|trans({'%count%': ''})|trim }}</strong></td>
                        </tr>

                        <tr>
                            <th class="bg-light"><i class="bi bi-tag text-primary me-2 text-dark"></i>{{ 'excursion_detail.table.category'|trans }}</th>
                            <td><strong>{{ excursion.categorie }}</strong></td>
                        </tr>

                        <tr>
                            <th class="bg-light"><i class="bi bi-geo-alt text-primary me-2 text-dark"></i>{{ 'excursion_detail.table.location'|trans }}</th>
                            <td><strong>{{ excursion.localisation }}</strong></td>
                        </tr>

                        <tr>
                            <th class="bg-light"><i class="bi bi-people text-primary me-2 text-dark"></i>{{ 'excursion_detail.table.ages'|trans }}</th>
                            <td><strong>{{ excursion.ages }}</strong></td>
                        </tr>

                        <tr>
                            <th class="bg-light"><i class="bi bi-person-badge text-primary me-2 text-dark"></i>{{ 'excursion_detail.table.max_people'|trans }}</th>
                            <td><strong>{{ excursion.maxPers }}</strong></td>
                        </tr>

                        <tr>
                            <th class="bg-light"><i class="bi bi-book text-primary me-2 text-dark"></i>{{ 'excursion_detail.table.guide'|trans }}</th>
                            <td><strong>{{ excursion.guide }}</strong></td>
                        </tr>
                    </tbody>
                </table>

            </div> <!-- FIN LEFT COLUMN -->

            <!-- RIGHT COLUMN : SIDEBAR -->
            <div class="col-lg-4 sticky-sidebar">

                {# ================= BLOC INFORMATIONS ================= #}
                <div class="info-box-modern mb-4 p-4 shadow-sm">
                    <h3 class="mb-4 fw-bold">{{ 'excursion_detail.sidebar.info_title'|trans }}</h3>
                            {# Bouton favoris #}
                            <button class="favorite-btn require-login" 
                                    data-excursion-id="{{ excursion.id }}" 
                                    data-action="add-favoris">
                                <i class="far fa-heart {% if excursion.id in userFavorisIds %}fas text-warning{% endif %}"></i>
                            </button>
                    <!-- Prix -->
                    <div class="d-flex align-items-start mb-4">
                        <div class="icon-circle me-3">
                            <i class="bi bi-cash-stack"></i>
                        </div>
                        <div>
                            <strong class="fs-5">{{ 'excursion_detail.sidebar.from'|trans }} {{ excursion.prixParPersonne }} TND</strong><br>
                            <small class="text-muted">{{ 'excursion_detail.sidebar.per_adult'|trans }}</small><br>
                            <a href="#" data-bs-toggle="modal" data-bs-target="#modalPrix" class="link-modern">
                                {{ 'excursion_detail.sidebar.low_price_guarantee'|trans }}
                            </a>
                        </div>
                    </div>

                    <!-- Réservez maintenant / Payez plus tard -->
                    <div class="d-flex align-items-start mb-4">
                        <div class="icon-circle me-3">
                            <i class="bi bi-arrow-repeat"></i>
                        </div>
                        <div>
                            <a href="#" data-bs-toggle="modal" data-bs-target="#modalReserver"
                            class="link-modern fw-semibold">{{ 'excursion_detail.sidebar.reserve_pay_later'|trans }}</a>
                            <ul class="mt-1">
                                <li>{{ 'excursion_detail.sidebar.reserve_pay_later_desc'|trans }}</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Annulation gratuite -->
                    {% if excursion.cancellation %}
                        <div class="d-flex align-items-start mb-4">
                            <div class="icon-circle me-3">
                                <i class="bi bi-shield-check"></i>
                            </div>
                            <div>
                                <a href="#" data-bs-toggle="modal" data-bs-target="#modalCancellation"
                                class="link-modern fw-semibold">{{ 'excursion_detail.sidebar.free_cancellation'|trans }}</a>
                                <ul class="mt-1">
                                    <li>{{ excursion.cancellation }}</li>{% if excursion.cancellation is empty %}<li>{{ 'excursion_detail.sidebar.free_cancellation'|trans }}</li>{% endif %}
                                </ul>
                            </div>
                        </div>
                    {% endif %}

                    <!-- BOUTON : OUVRIR MODAL -->
                    <div class="col-md-auto">
                        <button class="btn btn-animated btn-lg px-4" data-bs-toggle="modal" data-bs-target="#reservationModal">
                            {{ 'excursion_detail.sidebar.book_now'|trans }}
                        </button>
                    </div>

                </div>

                {# ================= BLOC QUESTIONS ================= #}
                <div class="info-box-modern mb-4 p-4 shadow-sm">
                    <h3 class="mb-3 fw-bold">{{ 'excursion_detail.questions.title'|trans }}</h3>

                    <div class="d-flex align-items-center mb-3">
                        <div class="icon-circle me-3">
                            <i class="bi bi-telephone-forward-fill"></i>
                        </div>
                        <strong class="fs-5">+216 26 341 186</strong>
                    </div>

                    <!-- Bouton ouverture chat -->
                    <div class="d-flex align-items-center">
                        <div class="icon-circle me-3">
                            <i class="bi bi-chat-right-dots-fill"></i>
                        </div>
                        <a href="#" id="open-chat" class="link-modern">{{ 'excursion_detail.questions.open_chat'|trans }}</a>
                    </div>
                </div>

                

                <!-- Fenêtre chat -->
                <div id="chat-widget">
                    <div class="chat-header">
                        <div>
                            <strong>Support</strong>
                            <div style="font-size:0.8rem;">{{ 'excursion_detail.questions.contact_admin'|trans }}</div>
                        </div>
                        <button id="close-chat">✕</button>
                    </div>
                    <div id="chat-messages">
                        <div class="text-muted small">{{ 'excursion_detail.questions.welcome_msg'|trans }}</div>
                    </div>
                    <div class="chat-footer">
                        <input type="text" id="chat-input" placeholder="{{ 'excursion_detail.questions.placeholder'|trans }}" maxlength="1000">
                        <button id="send-btn">{{ 'excursion_detail.questions.send'|trans }}</button>
                    </div>
                </div>
            </div> <!-- FIN RIGHT COLUMN -->

        </div> <!-- FIN ROW -->
    
        <!-- ACCORDION DÉTAILS DE L’EXCURSION -->
        <div class="col-lg-8 accordion mt-4" id="section-details-excursion">

            {% if excursion.inclusList|length > 0 %}
                <div class="accordion-item" id="section-details">
                    <h2 class="accordion-header" id="headingInclus">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInclus">
                            ✔️ {{ 'excursion_detail.accordion.included'|trans }}
                        </button>
                    </h2>
                    <div id="collapseInclus" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <ul>
                                {% for item in excursion.inclusList %}
                                    <li>{{ item.item }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            {% endif %}

            {% if excursion.nonInclusList|length > 0 %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingNonInclus">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNonInclus">
                            ❌ {{ 'excursion_detail.accordion.not_included'|trans }}
                        </button>
                    </h2>
                    <div id="collapseNonInclus" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <ul>
                                {% for item in excursion.nonInclusList %}
                                    <li>{{ item.item }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Détails de l'excursion triés par ordre -->
            {% if excursion.details|length > 0 %}
                {% set sortedDetails = excursion.details|sort((a, b) => a.ordre <=> b.ordre) %}

                {% set detailsAffiches = 0 %}

                {% for detail in sortedDetails %}
                    {% if detail.titre|trim is not empty and detail.description|trim is not empty %}
                        {% set detailsAffiches = detailsAffiches + 1 %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingDetail{{ detail.id }}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetail{{ detail.id }}">
                                    • {{ detail.titre }}
                                </button>
                            </h2>
                            <div id="collapseDetail{{ detail.id }}" class="accordion-collapse collapse">
                                <div class="accordion-body" style="line-height: 2;">
                                    {{ detail.description|nl2br|raw }}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}

                {% if detailsAffiches == 0 %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingDetailEmpty">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetailEmpty">
                                • {{ 'excursion_detail.accordion.details_title'|trans }}
                            </button>
                        </h2>
                        <div id="collapseDetailEmpty" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <p class="text-muted">{{ 'excursion_detail.accordion.no_details'|trans }}</p>
                            </div>
                        </div>
                    </div>
                {% endif %}

            {% else %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingDetailEmpty">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetailEmpty">
                            • {{ 'excursion_detail.accordion.details_title'|trans }}
                        </button>
                    </h2>
                    <div id="collapseDetailEmpty" class="accordion-collapse collapse show">
                        <div class="accordion-body">
                            <p class="text-muted">{{ 'excursion_detail.accordion.no_details'|trans }}</p>
                        </div>
                    </div>
                </div>
            {% endif %}

            {% if excursion.aPropos|length > 0 %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingApropos">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseApropos">
                            • {{ 'excursion_detail.accordion.expect'|trans }}
                        </button>
                    </h2>
                    <div id="collapseApropos" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            {{ excursion.aPropos|nl2br|raw }}
                        </div>
                    </div>
                </div>
            {% endif %}

        </div>


        

<!-- MODAL DE RESERVATION -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="reservationModalLabel">{{ 'reservation.excursion.title'|trans }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>

            {{ form_start(reservationForm) }}

            <div class="modal-body">

                <div class="row g-4">

                    <!-- Nom -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">{{ 'reservation.excursion.form.nom'|trans }}</label>
                        {{ form_widget(reservationForm.nom, {
                            'attr': {'class': 'form-control form-control-lg'}
                        }) }}
                        {{ form_errors(reservationForm.nom) }}
                    </div>

                    <!-- Prénom -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">{{ 'reservation.excursion.form.prenom'|trans }}</label>
                        {{ form_widget(reservationForm.prenom, {
                            'attr': {'class': 'form-control form-control-lg'}
                        }) }}
                        {{ form_errors(reservationForm.prenom) }}
                    </div>

                    <!-- Email -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">{{ 'reservation.excursion.form.email'|trans }}</label>
                        {{ form_widget(reservationForm.email, {
                            'attr': {
                                'class': 'form-control form-control-lg', 
                                'placeholder': 'reservation.excursion.form.email_placeholder'|trans, 
                                'type': 'email',
                                'pattern': '[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,}$',
                                'title': 'reservation.excursion.form.email_title'|trans,
                                'id': 'clientEmail'
                            }
                        }) }}
                        {{ form_errors(reservationForm.email) }}
                    </div>

                    <!-- Téléphone -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">{{ 'reservation.excursion.form.whatsapp'|trans }}</label>
                        {{ form_widget(reservationForm.tel, {
                            'attr': {'class': 'form-control form-control-lg', 'placeholder': 'reservation.excursion.form.whatsapp_placeholder'|trans}
                        }) }}
                        {{ form_errors(reservationForm.tel) }}
                    </div>

                    <!-- Adultes -->
                    <div class="col-md-4">
                        <label class="form-label fw-bold">{{ 'reservation.excursion.form.adults'|trans }}</label>
                        {{ form_widget(reservationForm.adult, {
                            'attr': {'class': 'form-control form-control-lg'}
                        }) }}
                        {{ form_errors(reservationForm.adult) }}
                    </div>

                    <!-- Enfants -->
                    <div class="col-md-4">
                        <label class="form-label fw-bold">{{ 'reservation.excursion.form.children'|trans }}</label>
                        {{ form_widget(reservationForm.child, {
                            'attr': {'class': 'form-control form-control-lg'}
                        }) }}
                        {{ form_errors(reservationForm.child) }}

                        <div class="form-text text-second fw-bold mt-1">
                            {{ 'reservation.excursion.form.children_discount'|trans }}
                        </div>
                    </div>
                    <!-- Date & Heure -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">{{ 'reservation.excursion.form.date_time'|trans }}</label>
                        {{ form_widget(reservationForm.dateHeure, {
                            'attr': {
                                'class': 'form-control form-control-lg',
                                'min': "now"|date("Y-m-d\\TH:i"),
                                'id': 'dateReservation'
                            }
                        }) }}
                        {{ form_errors(reservationForm.dateHeure) }}
                    </div>

                    <!-- Point de prise en charge -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">{{ 'reservation.excursion.form.pickup_point'|trans }}</label>
                        {{ form_widget(reservationForm.localisationPoint, {
                            'attr': {'class': 'form-control form-control-lg', 'placeholder': 'reservation.excursion.form.pickup_placeholder'|trans}
                        }) }}
                        {{ form_errors(reservationForm.localisationPoint) }}
                    </div>

                    <!-- Champ excursion caché -->
                    {{ form_widget(reservationForm.excursion) }}

                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-animated-secondary" data-bs-dismiss="modal">{{ 'reservation.excursion.btn.cancel'|trans }}</button>
                <button type="submit" class="btn btn-animated-primary">{{ 'reservation.excursion.btn.confirm'|trans }}</button>
            </div>


            {{ form_end(reservationForm) }}

        </div>
    </div>
</div>

<!-- MODAL CONFIRMATION -->
<div class="modal fade" id="reservationConfirmation" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">{{ 'reservation.excursion.confirmation.title'|trans }}</h5>
            </div>

            <div class="modal-body">

                <h4 class="mb-3">{{ 'reservation.excursion.confirmation.thank_you'|trans }}</h4>
                <p class="text-center mb-3">
                    {{ 'reservation.excursion.confirmation.email_sent'|trans }} <strong>{{ reservation.email }}</strong> {{ 'reservation.excursion.confirmation.contact_soon'|trans }}
                </p>

                <div class="card p-3 shadow-sm">
                    <h5 class="fw-bold mb-3">{{ 'reservation.excursion.confirmation.details_title'|trans }}</h5>

                    <p><strong>{{ 'reservation.excursion.confirmation.label_excursion'|trans }}</strong> {{ reservation.excursion.titre }}</p>
                    <p><strong>{{ 'reservation.excursion.confirmation.label_name'|trans }}</strong> {{ reservation.nom }} {{ reservation.prenom }}</p>
                    <p><strong>{{ 'reservation.excursion.confirmation.label_adults'|trans }}</strong> {{ reservation.adult }}</p>
                    <p><strong>{{ 'reservation.excursion.confirmation.label_children'|trans }}</strong> {{ reservation.child }}</p>
                    <p><strong>{{ 'reservation.excursion.confirmation.label_date'|trans }}</strong> {{ reservation.dateHeure|date('d/m/Y H:i') }}</p>
                    <p><strong>{{ 'reservation.excursion.confirmation.label_pickup'|trans }}</strong> {{ reservation.localisationPoint }}</p>
                    <p><strong>{{ 'reservation.excursion.confirmation.label_email'|trans }}</strong> {{ reservation.email }}</p>
                    <p><strong>{{ 'reservation.excursion.confirmation.label_whatsapp'|trans }}</strong> {{ reservation.tel }}</p>
                    <p><strong>{{ 'reservation.excursion.confirmation.label_total_price'|trans }}</strong> {{ reservation.prixTotal }} TND</p>


                    
                </div>

            </div>

            <div class="modal-footer">
                <a href="{{ path('app_front_excursions_list') }}" class="btn btn-primary">{{ 'reservation.excursion.confirmation.back_to_list'|trans }}</a>
            </div>

        </div>
    </div>
</div>



            <!-- DEUXIÈME ROW : Contenu full-width (Accordion + Itinéraire + Map) -->
            <div class="row mt-4">
                <div class="col-12">

                    <!-- Itinéraire + Map -->
                    <div class="excursion-container" 
                        style="display:flex; gap:20px; margin-top:30px; flex-wrap: wrap;">

                        <!-- LEFT : Itinéraire stylé TripAdvisor -->
                        <div style="flex: 1 1 40%; max-height:80vh; overflow-y:auto; padding-right:10px; min-width: 300px;">
                            <h2 class="section-title" id="section-itineraire">{{ 'excursion_detail.itinerary.title'|trans }}</h2>

                            <div class="itinerary-container-tripadvisor">

                                <!-- Point de Départ -->
                                <div class="itinerary-step-trip">
                                    <div class="itinerary-icon-trip start-icon">{{ 'excursion_detail.itinerary.start'|trans }}</div>
                                    <div class="itinerary-content-trip">
                                        <h5 class="fw-bold">{{ 'excursion_detail.itinerary.pickup'|trans }}</h5>
                                        
                                    </div>
                                </div>

                                {% set steps = excursion.itineraires|sort((a,b) => a.ordre <=> b.ordre) %}
                                {% for etape in steps %}
                                    {% set lat = etape.coordinates ? etape.coordinates|split(',')[0] : '' %}
                                    {% set lng = etape.coordinates ? etape.coordinates|split(',')[1] : '' %}

                                    <!-- Étape de l'itinéraire -->
                                    <div class="itinerary-step-trip etape-box"
                                        data-lat="{{ lat }}"
                                        data-lng="{{ lng }}">

                                        <div class="itinerary-icon-trip number-icon">{{ loop.index }}</div>

                                        <div class="itinerary-content-trip">
                                            <h5 class="fw-bold">{{ etape.titreEtape }}</h5>
                                            <p class="stop-details">
                                                {% if etape.dureeVisite %} {{ 'excursion_detail.itinerary.stop'|trans }} : {{ etape.dureeVisite }} {% endif %}
                                                {% if etape.admission %} 
                                                    <span class="admission-badge">{{ etape.admission }}</span> 
                                                {% endif %}
                                            </p>

                                            <!-- Lien pour afficher les détails -->
                                            <a href="javascript:void(0);" 
                                            class="itinerary-link toggle-details" 
                                            data-target="details-{{ loop.index }}">
                                                {% if etape.hasPhotos %} {{ 'excursion_detail.itinerary.see_details_photos'|trans }} {% else %} {{ 'excursion_detail.itinerary.see_details'|trans }} {% endif %}
                                            </a>

                                            <!-- Contenu caché (description + photos) -->
                                            <div class="details-content" id="details-{{ loop.index }}" style="display: none;">
                                                <p class="text-muted mt-3">{{ etape.descriptionEtape }}</p>

                                                {% if etape.photos|length > 0 %}
                                                    <div class="etape-photos mt-3">
                                                        <div class="row g-2">
                                                            {% for photo in etape.photos %}
                                                                <div class="col-6">
                                                                    <img src="{{ asset('uploads/itineraire_photos/' ~ photo.imageUrl) }}" 
                                                                        class="img-fluid rounded" 
                                                                        alt="{{ photo.legende }}"
                                                                        style="width: 100%; height: 150px; object-fit: cover; cursor: pointer;"
                                                                        onclick="openPhotoModal('{{ asset('uploads/itineraire_photos/' ~ photo.imageUrl) }}', '{{ photo.legende }}')">
                                                                    {% if photo.legende %}
                                                                        <small class="text-muted d-block mt-1">{{ photo.legende }}</small>
                                                                    {% endif %}
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                {% endif %}

                                                <a href="javascript:void(0);" 
                                                class="itinerary-link toggle-details mt-2" 
                                                data-target="details-{{ loop.index }}">
                                                    {{ 'excursion_detail.itinerary.see_less'|trans }}
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}


                                <!-- Point de Retour -->
                                <div class="itinerary-step-trip">
                                    <div class="itinerary-icon-trip end-icon">{{ 'excursion_detail.itinerary.destination'|trans }}</div>
                                    <div class="itinerary-content-trip">
                                        <h5 class="fw-bold">{{ 'excursion_detail.itinerary.return'|trans }}</h5>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- RIGHT : MAP -->
                        <div style="flex: 1 1 55%; min-width: 300px;">
                            <div class="map-header">
                                <button class="btn-recenter" onclick="recenterMap()">
                                    <i class="bi bi-crosshair"></i> {{ 'excursion_detail.itinerary.recenter_map'|trans }}
                                </button>
                            </div>
                            <div id="map" style="height:75vh; width:100%; border-radius:10px;"></div>
                        </div>

                    </div> <!-- fin Itinéraire + Map -->

                </div>
            </div> <!-- fin row full-width -->


        <!-- MODALS -->

        <!-- Modal Annulation -->
        <div class="modal fade" id="modalCancellation" tabindex="-1" aria-labelledby="modalCancellationLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-light">
                        <h5 class="modal-title" id="modalCancellationLabel">{{ 'excursion.modal.cancellation.title'|trans }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ 'common.close'|trans }}"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex align-items-start mb-4">
                            <i class="fas fa-info-circle  me-3 mt-1" style="font-size: 1.5rem; color: #d8b65d;"></i>
                            <div>
                                <h6 class="mb-2">{{ 'excursion.modal.cancellation.free_cancellation'|trans }}</h6>
                                <p class="text-muted mb-0">{{ 'excursion.modal.cancellation.free_cancellation_details'|trans }}</p>
                            </div>
                        </div>
                        <hr>
                        <div class="d-flex align-items-start">
                            <i class="fas fa-clock  me-3 mt-1" style="font-size: 1.5rem; color: #d8b65d;"></i>
                            <div>
                                <h6 class="mb-2">{{ 'excursion.modal.cancellation.departure_time'|trans }}</h6>
                                <p class="text-muted mb-0">{{ 'excursion.modal.cancellation.departure_time_details'|trans }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ 'common.close'|trans }}</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Réservez maintenant et payez plus tard -->
        <div class="modal fade" id="modalReserver" tabindex="-1" aria-labelledby="modalReserverLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-xl">
                <div class="modal-content" style="border-radius: 16px; padding: 10px 20px;">
                    <div class="modal-header border-0">
                        <h5 class="modal-title fw-bold" id="modalReserverLabel">{{ 'excursion.modal.book_now.title'|trans }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ 'common.close'|trans }}"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="p-4 rounded-3 h-100" style="background-color: #f8f9fa; border: 1px solid #e9ecef;">
                                    <div class="d-flex align-items-start mb-4">
                                        <div class=" bg-opacity-10 p-3 rounded-circle me-3" style="background-color: #2a3138; border: 1px solid #2a3138;">
                                            <i class="fas fa-credit-card " style="font-size: 1.5rem; color: #d8b65d;"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-2">{{ 'excursion.modal.book_now.secure_payment'|trans }}</h6>
                                            <p class="text-muted mb-0">{{ 'excursion.modal.book_now.secure_payment_details'|trans }}</p>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-start">
                                        <div class=" bg-opacity-10 p-3 rounded-circle me-3" style="background-color: #2a3138; border: 1px solid #2a3138;">
                                            <i class="fas fa-lock " style="font-size: 1.5rem; color: #d8b65d;"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-2">{{ 'excursion.modal.book_now.immediate_confirmation'|trans }}</h6>
                                            <p class="text-muted mb-0">{{ 'excursion.modal.book_now.immediate_confirmation_details'|trans }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-4 rounded-3 h-100" style="background-color: #f8f9fa; border: 1px solid #e9ecef;">
                                    <div class="d-flex align-items-start mb-4">
                                        <div class=" bg-opacity-10 p-3 rounded-circle me-3" style="background-color: #2a3138; border: 1px solid #2a3138;">
                                            <i class="fas fa-calendar-check " style="font-size: 1.5rem; color: #d8b65d;"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-2">{{ 'excursion.modal.book_now.free_cancellation'|trans }}</h6>
                                            <p class="text-muted mb-0">{{ 'excursion.modal.book_now.free_cancellation_details'|trans }}</p>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-start">
                                        <div class=" bg-opacity-10 p-3 rounded-circle me-3" style="background-color: #2a3138; border: 1px solid #2a3138;">
                                            <i class="fas fa-headset " style="font-size: 1.5rem; color: #d8b65d;"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-2">{{ 'excursion.modal.book_now.support'|trans }}</h6>
                                            <p class="text-muted mb-0">{{ 'excursion.modal.book_now.support_details'|trans }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ 'common.close'|trans }}</button>
                        
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Garantie Prix le Plus Bas -->
        <div class="modal fade" id="modalPrix" tabindex="-1" aria-labelledby="modalPrixLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content" style="border-radius: 12px;">
                    <div class="modal-header bg-warning bg-opacity-10">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-tag  me-3" style="font-size: 1.8rem; color: #d8b65d;"></i>
                            <div>
                                <h5 class="modal-title mb-0" id="modalPrixLabel">{{ 'excursion.modal.best_price.title'|trans }}</h5>
                                <p class="text-muted mb-0 small">{{ 'excursion.modal.best_price.subtitle'|trans }}</p>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ 'common.close'|trans }}"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="d-flex">
                                    <div class="me-3 " style="color: #d8b65d;">
                                        <i class="fas fa-check-circle" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h6>{{ 'excursion.modal.best_price.guaranteed_price'|trans }}</h6>
                                        <p class="text-muted mb-0">{{ 'excursion.modal.best_price.guaranteed_price_details'|trans }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex">
                                    <div class="me-3" style="color: #d8b65d;">
                                        <i class="fas fa-percentage" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h6>{{ 'excursion.modal.best_price.special_discount'|trans }}</h6>
                                        <p class="text-muted mb-0">{{ 'excursion.modal.best_price.special_discount_details'|trans }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex">
                                    <div class="me-3 " style="color: #d8b65d;">
                                        <i class="fas fa-shield-alt" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h6>{{ 'excursion.modal.best_price.no_hidden_fees'|trans }}</h6>
                                        <p class="text-muted mb-0">{{ 'excursion.modal.best_price.no_hidden_fees_details'|trans }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex">
                                    <div class="me-3 " style="color: #d8b65d;">
                                        <i class="fas fa-hand-holding-usd" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h6>{{ 'excursion.modal.best_price.best_rate'|trans }}</h6>
                                        <p class="text-muted mb-0">{{ 'excursion.modal.best_price.best_rate_details'|trans }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-warning mt-4">
                            <div class="d-flex">
                                <i class="fas fa-exclamation-triangle me-3 mt-1"></i>
                                <div>
                                    <strong>{{ 'excursion.modal.best_price.how_it_works'|trans }}</strong>
                                    <p class="mb-0">{{ 'excursion.modal.best_price.how_it_works_details'|trans }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ 'common.close'|trans }}</button>
                        
                    </div>
                </div>
            </div>
        </div>

        <div class="container mt-5">
            <div class="row">
                
                <!-- ========== COLONNE GAUCHE : AVIS ========== -->
                <div class="col-lg-6">
                    <section class="avis-section">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="mb-0">⭐ {{ 'excursion_detail.reviews.title'|trans }}</h3>
                            {% if app.user %}
                                <button type="button" class="btn btn-animated-primary" id="btnAvis">
                                    <i class="bi bi-plus-circle"></i> {{ 'excursion_detail.reviews.btn_give_opinion'|trans }}
                                </button>

                            {% endif %}

                        </div>

                        {% if noteMoyenne > 0 %}
                            <div class="alert alert-info mb-3">
                                <strong>{{ 'excursion_detail.reviews.avg_note'|trans }} :</strong> 
                                <span class="fs-5">{{ noteMoyenne|number_format(1) }}/5</span>
                                <span class="text-warning">⭐</span>
                                <small class="text-muted">({{ avis|length }} avis)</small>
                            </div>
                        {% endif %}
                        {% if not app.user %}
                            <small class="text-danger d-block mb-3">
                                ⚠️ {{ 'excursion_detail.reviews.login_required'|trans }}
                            </small>
                        {% endif %}


                        {% if avis is not empty %}
                            <div class="avis-list" style="max-height: 600px; overflow-y: auto;">
                                {% for a in avis %}
                                    <div class="card mb-3 shadow-sm">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div>
                                                    <strong>{{ a.user.email }}</strong>
                                                    {% if a.compagnon %}
                                                        <span class="badge bg-secondary ms-2">{{ a.compagnon }}</span>
                                                    {% endif %}
                                                </div>
                                                <div class="text-warning">
                                                    {% for i in 1..5 %}
                                                        {% if i <= a.note %}
                                                            ⭐
                                                        {% else %}
                                                            ☆
                                                        {% endif %}
                                                    {% endfor %}
                                                    <span class="text-dark ms-1">{{ a.note }}/5</span>
                                                </div>
                                            </div>

                                            {% if a.commentaire %}
                                                <p class="mt-2 mb-2">{{ a.commentaire }}</p>
                                            {% endif %}

                                            <small class="text-muted">
                                                <i class="bi bi-clock"></i> {{ a.createdAt|date('d/m/Y à H:i') }}
                                            </small>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-light text-center">
                                <p class="mb-0">{{ 'excursion_detail.reviews.no_reviews'|trans }}</p>
                            </div>
                        {% endif %}
                    </section>
                </div>

                <!-- ========== COLONNE DROITE : FAQ ========== -->
                <div class="col-lg-6">
                    <section class="faq-section">
                        <h3 class="mb-3">❓ {{ 'excursion_detail.faq.title'|trans }}</h3>
                         {% if not app.user %}
                            <small class="text-danger d-block mb-3">
                                ⚠️ {{ 'excursion_detail.faq.login_required'|trans }}
                            </small>
                        {% endif %}

                        <div class="faq-list" style="max-height: 600px; overflow-y: auto;">
                            {% if faqs is not empty %}
                                {% for faq in faqs|reverse %}
                                    <div class="faq-item mb-3 p-3 border rounded shadow-sm">
                                        <p class="fw-bold mb-1">{{ faq.question }}</p>
                                        <p class="mb-0">
                                            {% if faq.reponse %}
                                                {{ faq.reponse|nl2br }}
                                            {% else %}
                                                <em>{{ 'excursion_detail.faq.waiting_answer'|trans }}</em>
                                            {% endif %}
                                        </p>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="alert alert-light text-center">
                                    <p class="mb-0">{{ 'excursion_detail.faq.no_questions'|trans }}</p>
                                </div>
                            {% endif %}
                        </div>

                        {% if is_granted('IS_AUTHENTICATED_FULLY') %}
                            <!-- FORMULAIRE POUR POSER UNE QUESTION -->
                            <div class="card mt-4 ">
                                <div class="card-header text-white">
                                    <h5 class="mb-0">💬 {{ 'excursion_detail.faq.ask_title'|trans }}</h5>
                                </div>
                                <div class="card-body">
                                    {{ form_start(faqForm, {'attr': {'id': 'faqForm'}}) }}
                                        {{ form_row(faqForm.question, {
                                            'attr': {'class': 'form-control', 'rows': 3}
                                        }) }}
                                        <button type="submit" class="btn btn-animated-primary mt-2">
                                            <i class="bi bi-send"></i> {{ 'excursion_detail.faq.btn_send'|trans }}
                                        </button>

                                    {{ form_end(faqForm) }}
                                    <small class="text-muted d-block mt-2">
                                        {{ 'excursion_detail.faq.moderation_note'|trans }}
                                    </small>
                                </div>
                            </div>
                     
                           
                           
                        {% endif %}

                    </section>
                </div>

            </div>
        </div>

        <!-- ========== MODAL AVIS ========== -->
        <div class="modal fade" id="modalAvis" tabindex="-1" aria-labelledby="modalAvisLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header ">
                        <h5 class="modal-title" id="modalAvisLabel">
                            <i class="bi bi-star-fill"></i> {{ 'excursion_detail.reviews.modal_title'|trans }}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    {{ form_start(avisForm, {'attr': {'id': 'formAvis'}}) }}
                    <div class="modal-body">
                        
                    
                        <div class="mb-4">
                            <label class="form-label fw-bold">{{ 'excursion_detail.reviews.label_companion'|trans }}</label>
                            {{ form_widget(avisForm.compagnon, {
                                'attr': {'class': 'form-select'}
                            }) }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">{{ 'excursion_detail.reviews.label_comment'|trans }}</label>
                            {{ form_widget(avisForm.commentaire, {
                                'attr': {
                                    'class': 'form-control',
                                    'rows': 5,
                                    'placeholder': 'excursion_detail.reviews.placeholder_comment'|trans
                                }
                            }) }}
                        </div>

                        <div class="star-rating">
                            {% for i in 5..1 %}
                                <input type="radio" id="note{{ i }}" name="{{ avisForm.note.vars.full_name }}" value="{{ i }}">
                                <label for="note{{ i }}"></label>
                            {% endfor %}
                        </div>


                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-animated-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> {{ 'excursion_detail.reviews.btn_cancel'|trans }}
                        </button>
                        <button type="submit" class="btn btn-animated-primary">
                            <i class="bi bi-send-fill"></i> {{ 'excursion_detail.reviews.btn_send'|trans }}
                        </button>
                    </div>

                    {{ form_end(avisForm) }}

                </div>
            </div>
        </div>

</div>
{% endblock %}



{% block script %}

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="{{ asset('assetsFront/js/excursion_details.js') }}"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        window.APP = {
            isLoggedIn: {{ app.user ? 'true' : 'false' }}
        };
    </script>

    {% if reservationOK %}
    <script>
        window.APP = window.APP || {};
        window.APP.showReservationConfirmation = true;
    </script>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
        const openBtn = document.getElementById('open-chat');
        const chatWidget = document.getElementById('chat-widget');
        const closeBtn = document.getElementById('close-chat');
        const sendBtn = document.getElementById('send-btn');
        const chatInput = document.getElementById('chat-input');
        const messagesBox = document.getElementById('chat-messages');

        const isLoggedIn = {{ app.user ? 'true' : 'false' }};

        // Ouvrir le chat
        openBtn?.addEventListener('click', function(e) {
            e.preventDefault();
            if (!isLoggedIn) {
                // Si pas connecté → ouvrir modal login
                $('#loginModal').modal('show');
                return;
            }

            if (chatWidget) {
                chatWidget.style.display = 'flex';
                chatWidget.style.flexDirection = 'column';
                chatInput?.focus();
            }
        });

        // Fermer le chat
        closeBtn?.addEventListener('click', function() {
            if (chatWidget) chatWidget.style.display = 'none';
        });

        // Envoyer message
        sendBtn?.addEventListener('click', function() {
            const msg = chatInput.value.trim();
            if (!msg) return;

            sendBtn.disabled = true;

            const formData = new URLSearchParams();
            formData.append('message', msg);

            fetch('/chat/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData.toString()
            })
            .then(resp => resp.json())
            .then(json => {
                sendBtn.disabled = false;
                if (json.status === 'ok' && json.wa_link) {
                    appendMessage(msg, 'user');
                    chatInput.value = '';
                    window.open(json.wa_link, '_blank');
                } else {
                    appendMessage("Erreur: " + (json.message || "Erreur inconnue"), 'admin');
                }
            })
            .catch(err => {
                sendBtn.disabled = false;
                appendMessage('Erreur réseau.', 'admin');
                console.error(err);
            });
        });

        // Enter pour envoyer
        chatInput?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendBtn?.click();
            }
        });

        // Fonction pour afficher les messages dans le chat
        function appendMessage(text, type='user') {
            if (!messagesBox) return;
            const div = document.createElement('div');
            div.className = type === 'user' ? 'message-user' : 'message-admin';
            div.textContent = text;
            messagesBox.appendChild(div);
            messagesBox.scrollTop = messagesBox.scrollHeight;
        }
    });
    </script>
    <script src="{{ asset('assetsFront/js/excursion_details.js') }}"></script>



{% endblock %}